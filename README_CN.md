# Hetero-Compute-Router (HCS)

[![CI](https://github.com/iannil/hetero-compute-router/workflows/CI/badge.svg)](https://github.com/iannil/hetero-compute-router/actions)
[![Helm](https://github.com/iannil/hetero-compute-router/workflows/Helm%20Lint/badge.svg)](https://github.com/iannil/hetero-compute-router/actions)
[![Go Report Card](https://goreportcard.com/badge/github.com/iannil/hetero-compute-router)](https://goreportcard.com/report/github.com/iannil/hetero-compute-router)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Kubernetes](https://img.shields.io/badge/kubernetes-%3E%3D%201.24-blue)](https://kubernetes.io/)

HCS (Hetero-Compute-Router) æ˜¯ä¸€ä¸ªåŸºäº Kubernetes çš„å¼‚æ„ç®—åŠ›è™šæ‹ŸåŒ–ä¸é€‚é…å±‚ã€‚å®ƒæŠ½è±¡å±è”½ä¸åŒå‚å•†ï¼ˆNVIDIAã€åä¸ºæ˜‡è…¾ã€æµ·å…‰ã€å¯’æ­¦çºªï¼‰çš„ç¡¬ä»¶å·®å¼‚ï¼Œå®ç° AI å·¥ä½œè´Ÿè½½çš„ "ä¸€æ¬¡ç¼–å†™ï¼Œéšå¤„è¿è¡Œ"ã€‚

[English](README.md) | [ä¸­æ–‡](README_CN.md)

---

## ç›®å½•

- [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
- [è§£å†³æ–¹æ¡ˆï¼šè½¯ç¡¬è§£è€¦](#è§£å†³æ–¹æ¡ˆè½¯ç¡¬è§£è€¦)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æ”¯æŒçš„ç¡¬ä»¶](#æ”¯æŒçš„ç¡¬ä»¶)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [å¼€å‘è·¯çº¿å›¾](#å¼€å‘è·¯çº¿å›¾)
- [å‚ä¸è´¡çŒ®](#å‚ä¸è´¡çŒ®)
- [å¼€æºè®¸å¯](#å¼€æºè®¸å¯)

---

## é—®é¢˜èƒŒæ™¯

ç°ä»£ AI åŸºç¡€è®¾æ–½é¢ä¸´é‡å¤§æŒ‘æˆ˜ï¼š

| æŒ‘æˆ˜ | æè¿° |
| ------ | ------ |
| å‚å•†é”å®š | åº”ç”¨ä¸ç‰¹å®šç¡¬ä»¶ç´§å¯†è€¦åˆï¼ˆå¦‚ `nvidia.com/gpu`ï¼‰ |
| ç¡¬ä»¶ç¢ç‰‡åŒ– | GPU/NPU ç”Ÿæ€å¤šæ ·ï¼ˆNVIDIAã€åä¸ºã€æµ·å…‰ã€å¯’æ­¦çºªï¼‰ï¼ŒAPI äº’ä¸å…¼å®¹ |
| èµ„æºç²’åº¦ç²— | å³ä½¿åªéœ€è¦éƒ¨åˆ†èµ„æºï¼Œä¹Ÿå¿…é¡»åˆ†é…æ•´å¼  GPU |
| æ‹“æ‰‘æ— æ„ŸçŸ¥ | æ ‡å‡†è°ƒåº¦å™¨å¿½ç•¥äº’è”æ‹“æ‰‘ï¼ˆNVLinkã€HCCSã€PCIeï¼‰ |
| å®¹é”™èƒ½åŠ›å¼± | ç¼ºä¹å›½äº§èŠ¯ç‰‡çš„äºšå¥åº·æ£€æµ‹å’Œè‡ªåŠ¨æ•…éšœè½¬ç§» |

ä¼ ç»Ÿæ–¹å¼ï¼š

```
ç”¨æˆ·ç”³è¯· nvidia.com/gpu â†’ åªèƒ½è°ƒåº¦åˆ° NVIDIA èŠ‚ç‚¹
```

HCS æ–¹å¼ï¼š

```
ç”¨æˆ·ç”³è¯· ai.compute/vram: 16Gi â†’ HCS åˆ†æé›†ç¾¤ç°çŠ¶ â†’
åŠ¨æ€åˆ†é… NVIDIA A100 æˆ– åä¸ºæ˜‡è…¾ 910B â†’
è‡ªåŠ¨æ³¨å…¥å¯¹åº”çš„é©±åŠ¨åº“å’Œç¯å¢ƒå˜é‡
```

---

## è§£å†³æ–¹æ¡ˆï¼šè½¯ç¡¬è§£è€¦

HCS å®ç° ä¸‰å±‚è§£è€¦æ¨¡å‹ï¼Œå°†ç”¨æˆ·å·¥ä½œè´Ÿè½½ä¸ç¡¬ä»¶ç»†èŠ‚åˆ†ç¦»ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·è¯·æ±‚å±‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Pod è¯·æ±‚: ai.compute/vram: 16Gi, ai.compute/tflops-fp16: "100"      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è°ƒåº¦ä¸æ³¨å…¥å±‚ (HCS)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   è°ƒåº¦å™¨æ‰©å±•      â”‚â”€â”€â”€â–¶â”‚   Webhook       â”‚â”€â”€â”€â–¶â”‚  ä¿®æ”¹åçš„ Pod    â”‚          â”‚
â”‚  â”‚   Extension     â”‚    â”‚   æ³¨å…¥å™¨         â”‚    â”‚  (å«é©±åŠ¨é…ç½®)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         èµ„æºæŠ½è±¡å±‚ (URA)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      ComputeNode CRD                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚    â”‚
â”‚  â”‚  â”‚ NVIDIA  â”‚  â”‚  åä¸º    â”‚  â”‚   æµ·å…‰  â”‚  â”‚  å¯’æ­¦çºª  â”‚                â”‚    â”‚
â”‚  â”‚  â”‚ A100x8  â”‚  â”‚ 910Bx8  â”‚  â”‚ DCUx8   â”‚  â”‚ MLUx8   â”‚                â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç‰¹æ€§

### 1. ç»Ÿä¸€èµ„æºæŠ½è±¡ (URA)

Node-Agent éƒ¨ç½²åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½¿ç”¨åŸç”Ÿ APIï¼ˆNVMLã€DSMIã€CNMonï¼‰é‡‡é›†ç¡¬ä»¶ä¿¡æ¯ï¼Œä¸ŠæŠ¥ "ç®—åŠ›æŒ‡çº¹"ï¼š

- æ˜¾å­˜ (VRAM)ï¼šæ€»é‡å’Œå¯ç”¨é‡
- è®¡ç®—èƒ½åŠ›ï¼šFP16/FP32/INT8 ç®—åŠ› (TFLOPS)
- äº’è”æ‹“æ‰‘ï¼šNVLink/HCCS/RoCE/PCIe å¸¦å®½å’Œå»¶è¿Ÿ
- å¥åº·è¯„åˆ†ï¼šå®æ—¶ç¡¬ä»¶å¥åº·ç›‘æ§ï¼ˆå¯¹å›½äº§èŠ¯ç‰‡è‡³å…³é‡è¦ï¼‰

### 2. æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦

HCS è°ƒåº¦å™¨æ‰©å±• Kubernetes è°ƒåº¦æ¡†æ¶ï¼Œå®ç°æ™ºèƒ½è°ƒåº¦æ’ä»¶ï¼š

| æ’ä»¶ | åŠŸèƒ½ |
| ------ | ------ |
| Filter | è¿‡æ»¤ä¸æ»¡è¶³ç®—åŠ›éœ€æ±‚çš„èŠ‚ç‚¹ |
| Score | ä¼˜å…ˆé€‰æ‹©é«˜å¸¦å®½äº’è”å’Œæœ€ä¼˜ç¢ç‰‡åŒ–ç¨‹åº¦çš„èŠ‚ç‚¹ |
| Reserve | åœ¨ç»‘å®šå‰é¢„ç•™æ˜¾å­˜é…é¢ |
| Bind | é™„åŠ ç¡¬ä»¶ç»‘å®šæ³¨è§£ |

æ‰“åˆ†å› ç´ ï¼š

- äº’è”äº²å’Œæ€§ï¼ˆä¼˜å…ˆé€‰æ‹© NVLink/HCCS è€Œé PCIeï¼‰
- è£…ç®±ä¼˜åŒ–ï¼ˆæœ€å°åŒ–ç¢ç‰‡ï¼‰
- å¥åº·åŠ æƒï¼ˆé™ä½äºšå¥åº·èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼‰
- ç®—åŠ›æ±‡ç‡ï¼ˆè·¨å‚å•†ç­‰æ•ˆæ¢ç®—ï¼‰

### 3. è¿è¡Œæ—¶æ³¨å…¥ï¼ˆå˜æ›´ Webhookï¼‰

è¿è¡Œæ—¶æ³¨å…¥å™¨ æ ¹æ®ç›®æ ‡ç¡¬ä»¶è‡ªåŠ¨é…ç½®å®¹å™¨ç¯å¢ƒï¼š

```yaml
# HCS Webhook å¤„ç†å‰
spec:
  containers:
  - name: pytorch
    image: pytorch/pytorch:latest
    resources:
      requests:
        ai.compute/vram: "16Gi"

# HCS Webhook å¤„ç†åï¼ˆè‡ªåŠ¨æ³¨å…¥åä¸ºæ˜‡è…¾é…ç½®ï¼‰
spec:
  containers:
  - name: pytorch
    image: pytorch/pytorch:latest
    env:
    - name: ASCEND_VISIBLE_DEVICES
      value: "0,1"
    - name: LD_LIBRARY_PATH
      value: "/usr/local/Ascend/driver/lib64"
    volumeMounts:
    - name: ascend-driver
      mountPath: /usr/local/Ascend
  volumes:
  - name: ascend-driver
    hostPath:
      path: /usr/local/Ascend
```

### 4. è½¯ä»¶å®šä¹‰æ˜¾å­˜åˆ‡åˆ†ï¼ˆè§„åˆ’ä¸­ï¼‰

libhcs_interceptor.so å®ç°æ— éœ€ç¡¬ä»¶è™šæ‹ŸåŒ–çš„é…é¢å¼ºåˆ¶æ‰§è¡Œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨ç¨‹åº (PyTorch)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ cudaMalloc()
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   libhcs_interceptor.so (LD_PRELOAD)    â”‚
â”‚  - æ‹¦æˆª cudaMalloc/aclrtMalloc           â”‚
â”‚  - å¼ºåˆ¶æ‰§è¡Œæ˜¾å­˜é…é¢ (HCS_VRAM_QUOTA)       â”‚
â”‚  - è¶…å‡ºé…é¢è¿”å› OOM é”™è¯¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å‚å•†é©±åŠ¨ (CUDA/Ascend)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ç®—åŠ›æ±‡ç‡æ¢ç®—

æ”¯æŒåŸºäºæ€§èƒ½ç­‰æ•ˆçš„è·¨å‚å•†è°ƒåº¦ï¼š

```yaml
scheduler:
  exchangeRates:
    nvidia-a100: 1.0      # åŸºå‡†
    nvidia-a800: 0.95
    nvidia-h100: 1.5
    huawei-910b: 0.85
    hygon-dcu: 0.6
```

---

## ç³»ç»Ÿæ¶æ„

### ç»„ä»¶æ¦‚è§ˆ

| ç»„ä»¶ | ç±»å‹ | æè¿° |
| ------ | ------ | ------ |
| Node-Agent | DaemonSet | é‡‡é›†ç¡¬ä»¶ä¿¡æ¯ï¼Œä¸ŠæŠ¥ ComputeNode CRD |
| Scheduler | Deployment | æ‰©å±• K8s è°ƒåº¦å™¨ï¼Œå®ç°ç®—åŠ›æ„ŸçŸ¥è°ƒåº¦ |
| Webhook | Deployment | å˜æ›´ Podï¼Œæ³¨å…¥è¿è¡Œæ—¶ç¯å¢ƒ |
| Interceptor | åº“æ–‡ä»¶ | ï¼ˆè§„åˆ’ä¸­ï¼‰é€šè¿‡ LD_PRELOAD å®ç°è½¯ä»¶æ˜¾å­˜åˆ‡åˆ† |

### ComputeNode CRD

```yaml
apiVersion: hetero.zrs.io/v1alpha1
kind: ComputeNode
metadata:
  name: gpu-node-01
spec:
  vendor: nvidia
  devices:
    - id: "0"
      model: "A100-80G"
      vram: "80Gi"
      compute:
        fp16: "312"
        fp32: "19.5"
      topology:
        busId: "0000:17:00.0"
        links:
          - type: nvlink
            peers: ["1", "2", "3"]
            bandwidth: "600GB/s"
      healthScore: 100
status:
  phase: Ready
  vramAllocatable: "80Gi"
  vramAllocated: "16Gi"
```

---

## æ”¯æŒçš„ç¡¬ä»¶

| å‚å•† | äº§å“ | æ£€æµ‹ | è°ƒåº¦ | æ³¨å…¥ | æ˜¾å­˜åˆ‡åˆ† |
| ------ | ------ | ------ | ------ | ------ | ---------- |
| NVIDIA | A100/A800/H100/V100 | âœ… | âœ… | âœ… | ğŸ”„ è§„åˆ’ä¸­ |
| åä¸º | æ˜‡è…¾ 910A/910B | âœ… | âœ… | âœ… | ğŸ”„ è§„åˆ’ä¸­ |
| æµ·å…‰ | DCU Z100 | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ |
| å¯’æ­¦çºª | MLU370 | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ | ğŸ”„ è§„åˆ’ä¸­ |

---

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

- Kubernetes 1.24+
- Helm 3.10+
- cert-manager 1.12+ï¼ˆæ¨èç”¨äº TLSï¼‰
- è‡³å°‘ä¸€ä¸ª GPU/NPU èŠ‚ç‚¹

### å®‰è£…

æ–¹å¼ä¸€ï¼šOCI Registryï¼ˆæ¨èï¼‰

```bash
helm install hcs oci://ghcr.io/iannil/hetero-compute-router/charts/hcs \
  --namespace hcs-system \
  --create-namespace
```

æ–¹å¼äºŒï¼šä»æºç å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/iannil/hetero-compute-router.git
cd hetero-compute-router

# å®‰è£… CRD
kubectl apply -f config/crd/

# ä½¿ç”¨ Helm å®‰è£…
helm install hcs ./chart/hcs \
  --namespace hcs-system \
  --create-namespace
```

### éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -n hcs-system

# é¢„æœŸè¾“å‡ºï¼š
# NAME                             READY   STATUS    RESTARTS   AGE
# hcs-node-agent-xxxxx             1/1     Running   0          1m
# hcs-scheduler-xxxxxxxxxx-xxxxx   1/1     Running   0          1m
# hcs-webhook-xxxxxxxxxx-xxxxx     1/1     Running   0          1m

# æ£€æŸ¥ ComputeNode èµ„æº
kubectl get computenodes

# é¢„æœŸè¾“å‡ºï¼ˆæœ‰ GPU èŠ‚ç‚¹æ—¶ï¼‰ï¼š
# NAME          VENDOR   NODE        PHASE   VRAM          AGE
# gpu-node-01   nvidia   gpu-node-01 Ready   85899345920   1m
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

è¯·æ±‚æŠ½è±¡ç®—åŠ›èµ„æºï¼Œè€Œéå‚å•†ç‰¹å®šèµ„æºï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ai-workload
spec:
  schedulerName: hcs-scheduler
  containers:
  - name: pytorch
    image: pytorch/pytorch:latest
    resources:
      requests:
        ai.compute/vram: "16Gi"
        ai.compute/tflops-fp16: "100"
```

### PyTorch è®­ç»ƒç¤ºä¾‹

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pytorch-training
  labels:
    app: pytorch
spec:
  schedulerName: hcs-scheduler
  containers:
  - name: pytorch
    image: pytorch/pytorch:2.1.0-cuda12.1-cudnn8-runtime
    command: ["python", "train.py"]
    resources:
      requests:
        ai.compute/vram: "32Gi"
      limits:
        ai.compute/vram: "64Gi"
```

### å¤š GPU ä½œä¸šï¼ˆæ‹“æ‰‘åå¥½ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: distributed-training
  annotations:
    hcs.io/topology-preference: "high-bandwidth"
spec:
  schedulerName: hcs-scheduler
  containers:
  - name: pytorch
    image: pytorch/pytorch:latest
    resources:
      requests:
        ai.compute/vram: "160Gi"  # 2x 80GB GPU
        ai.compute/tflops-fp16: "600"
```

---

## é…ç½®è¯´æ˜

### Helm Values æ¦‚è§ˆ

| å‚æ•° | æè¿° | é»˜è®¤å€¼ |
| ------ | ------ | -------- |
| `nodeAgent.enabled` | å¯ç”¨ Node-Agent DaemonSet | `true` |
| `nodeAgent.logLevel` | æ—¥å¿—çº§åˆ« (debug/info/warn/error) | `info` |
| `nodeAgent.reportInterval` | å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰ | `30` |
| `scheduler.enabled` | å¯ç”¨ HCS è°ƒåº¦å™¨ | `true` |
| `scheduler.replicas` | è°ƒåº¦å™¨å‰¯æœ¬æ•° | `1` |
| `scheduler.leaderElection.enabled` | å¯ç”¨ Leader é€‰ä¸¾ | `true` |
| `webhook.enabled` | å¯ç”¨å˜æ›´ Webhook | `true` |
| `webhook.replicas` | Webhook å‰¯æœ¬æ•° | `2` |
| `webhook.failurePolicy` | Webhook å¤±è´¥ç­–ç•¥ | `Fail` |

### ç¯å¢ƒç‰¹å®šé…ç½®

å¼€å‘ç¯å¢ƒï¼š

```bash
helm install hcs ./chart/hcs \
  -f ./chart/hcs/values-dev.yaml \
  --namespace hcs-dev \
  --create-namespace
```

ç”Ÿäº§ç¯å¢ƒï¼š

```bash
helm install hcs ./chart/hcs \
  -f ./chart/hcs/values-prod.yaml \
  --namespace hcs-system \
  --create-namespace
```

å®Œæ•´é…ç½®å‚è€ƒè¯·æŸ¥çœ‹ [é…ç½®å‚æ•°è¯´æ˜](docs/deployment/configuration.md)ã€‚

---

## å¼€å‘è·¯çº¿å›¾

### Phase 1: The Observerï¼ˆå…¨çŸ¥ä¹‹çœ¼ï¼ŒMVPï¼‰âœ…

- [x] æ”¯æŒ NVIDIA/æ˜‡è…¾æ£€æµ‹çš„ Node-Agent
- [x] ComputeNode CRD å®šä¹‰
- [x] åŸºç¡€è°ƒåº¦é€»è¾‘
- [x] Helm Chart éƒ¨ç½²

### Phase 2: The Routerï¼ˆç®—åŠ›è·¯ç”±ï¼Œå½“å‰é˜¶æ®µï¼‰

- [x] ç®—åŠ›æ±‡ç‡æ¢ç®—
- [x] å˜æ›´å‡†å…¥ Webhook
- [x] é©±åŠ¨å’Œç¯å¢ƒå˜é‡æ³¨å…¥
- [ ] è·¨å‚å•†å…¼å®¹æ€§æµ‹è¯•

### Phase 3: The Virtualizerï¼ˆç®—åŠ›è™šæ‹ŸåŒ–ï¼Œè§„åˆ’ä¸­ï¼‰

- [ ] `libhcs_interceptor.so` æ˜¾å­˜åˆ‡åˆ†
- [ ] åŠ¨æ€é•œåƒé‡å®š
- [ ] åŸºäº eBPF çš„äºšå¥åº·æ£€æµ‹
- [ ] è‡ªåŠ¨ Checkpoint æ¢å¤

### ç‰ˆæœ¬è®¡åˆ’

| ç‰ˆæœ¬ | ç›®æ ‡æ—¶é—´ | ä¸»è¦åŠŸèƒ½ |
| ------ | ---------- | ---------- |
| v0.1.0-alpha | 2026 Q2 | Phase 1 MVP |
| v0.2.0-beta | 2026 Q3 | Phase 2 å®Œæˆ |
| v0.3.0-beta | 2026 Q4 | Phase 3 å®Œæˆ |
| v1.0.0 | 2027 Q1 | ç”Ÿäº§å°±ç»ªç‰ˆæœ¬ |

---

## ä¸ç°æœ‰æ–¹æ¡ˆå¯¹æ¯”

| åŠŸèƒ½ç‰¹æ€§ | K8s åŸç”Ÿ | Volcano/YuniKorn | HCS |
| ---------- | ---------- | ------------------ | --------- |
| èµ„æºç²’åº¦ | æ•´å¡ | é™æ€ MPS | åŠ¨æ€è½¯åˆ‡åˆ† |
| å¼‚æ„æ”¯æŒ | åŸºäº Label | Device Plugin | ç»Ÿä¸€æŠ½è±¡ |
| è¿è¡Œæ—¶ç¯å¢ƒ | æ‰‹åŠ¨é…ç½® | æ‰‹åŠ¨é…ç½® | è‡ªåŠ¨æ³¨å…¥ |
| æ‹“æ‰‘æ„ŸçŸ¥ | æ—  | ä»… NUMA | è·¨èŠ¯ç‰‡äº’è” |
| å®¹é”™å¤„ç† | Pod é‡å¯ | ä»»åŠ¡é‡è¯• | äºšå¥åº·éš”ç¦» + Checkpoint |
| å®šä½ | èµ„æºè°ƒåº¦ | æ‰¹å¤„ç†è°ƒåº¦ | ç®—åŠ›è™šæ‹ŸåŒ–å±‚ |

---

## ä»æºç æ„å»º

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/iannil/hetero-compute-router.git
cd hetero-compute-router

# æ„å»ºæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
make build

# è¿è¡Œæµ‹è¯•
make test

# æ„å»º Docker é•œåƒ
make docker-build

# æ¨é€é•œåƒï¼ˆéœ€è¦è®¤è¯ï¼‰
make docker-push
```

---

## å‚ä¸è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹ [è´¡çŒ®æŒ‡å—](CONTRIBUTING.md) äº†è§£è¯¦æƒ…ã€‚

### å¼€å‘è®¾ç½®

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/my-feature`
3. ä¿®æ”¹ä»£ç å¹¶æ·»åŠ æµ‹è¯•
4. è¿è¡Œä»£ç æ£€æŸ¥ï¼š`make lint`
5. æäº¤ Pull Request

### ä»£ç ç»“æ„

```
hetero-compute-router/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ node-agent/      # Node-Agent å…¥å£
â”‚   â”œâ”€â”€ scheduler/       # è°ƒåº¦å™¨æ‰©å±•å…¥å£
â”‚   â””â”€â”€ webhook/         # Webhook æœåŠ¡å…¥å£
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ api/v1alpha1/    # CRD ç±»å‹å’Œ deepcopy
â”‚   â”œâ”€â”€ agent/           # Node-Agent é€»è¾‘
â”‚   â”œâ”€â”€ collectors/      # ç¡¬ä»¶é‡‡é›†å™¨
â”‚   â”œâ”€â”€ detectors/       # ç¡¬ä»¶æ£€æµ‹å™¨ (NVML, DSMI)
â”‚   â”œâ”€â”€ exchange/        # ç®—åŠ›æ±‡ç‡
â”‚   â”œâ”€â”€ interceptor/     # API åŠ«æŒåº“ï¼ˆè§„åˆ’ä¸­ï¼‰
â”‚   â”œâ”€â”€ scheduler/       # è°ƒåº¦å™¨æ’ä»¶
â”‚   â””â”€â”€ webhook/         # å‡†å…¥ Webhook
â”œâ”€â”€ chart/hcs/           # Helm Chart
â”œâ”€â”€ config/              # Kubernetes æ¸…å•
â”œâ”€â”€ docs/                # æ–‡æ¡£
â””â”€â”€ hack/                # æ„å»ºè„šæœ¬
```

---

## ç¤¾åŒº

- GitHub Issuesï¼š[æŠ¥å‘Š Bug æˆ–æå‡ºåŠŸèƒ½å»ºè®®](https://github.com/iannil/hetero-compute-router/issues)
- Discussionsï¼š[æé—®å’Œåˆ†äº«æƒ³æ³•](https://github.com/iannil/hetero-compute-router/discussions)

---

## å¼€æºè®¸å¯

æœ¬é¡¹ç›®é‡‡ç”¨ Apache License 2.0 è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## è‡´è°¢

HCS çš„è¯ç”Ÿæºäºç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†å¼‚æ„ AI åŸºç¡€è®¾æ–½çš„æŒ‘æˆ˜ã€‚ç‰¹åˆ«æ„Ÿè°¢ï¼š

- Kubernetes è°ƒåº¦æ¡†æ¶æä¾›çš„å¯æ‰©å±•è°ƒåº¦èƒ½åŠ›
- NVIDIA NVML å’Œåä¸º DSMI æä¾›çš„ç¡¬ä»¶æ£€æµ‹ API
- äº‘åŸç”Ÿç¤¾åŒºçš„æŒç»­åˆ›æ–°

---

HCSï¼šæ¶ˆé™¤å‚å•†é”å®šï¼Œé‡Šæ”¾ç®—åŠ›è‡ªç”±ã€‚
